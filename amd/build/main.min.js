define(["jquery","core/ajax","core/notification","core/str","core/templates","core/url","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g,h){return{searchid:0,loadpositions:{},cancelPackageForm:function(a){d.get_strings([{key:"removal:title",component:"block_edupublisher"},{key:"removal:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(b){c.confirm(b[0],b[1],b[2],b[3],function(){top.location.href=a})}).fail(c.exception)},clickImportConfirmation:function(){a('#page-content div[role="main"] form[action*="/edupublisher/pages/import.php"]').submit()},confirmRemoval:function(a){d.get_strings([{key:"removal:title",component:"block_edupublisher"},{key:"removal:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(b){c.confirm(b[0],b[1],b[2],b[3],function(){top.location.href=a})}).fail(c.exception)},exportCourseWarning:function(){var b=a("#id_exportcourse").is(":checked");b||d.get_strings([{key:"exportcourse",component:"block_edupublisher"},{key:"exportcourse_help",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(b){c.confirm(b[0],b[1],b[2],b[3],function(){},function(){a("#id_exportcourse").prop("checked",!0)})}).fail(c.exception)},initImportSelection:function(a,b){d.get_strings([{key:"import",component:"core"}]).done(function(c){g.create({title:c[0],body:e.render("block_edupublisher/init_import_selection",{packageid:a,courseid:b})}).done(function(a){a.show()})}).fail(c.exception)},initImportLoadGo:function(b){var c=a("#courseid-"+b).val(),d=a("#packageid-"+b).val(),e=a("#sectionid-"+b).val();top.location.href=f.fileUrl("/blocks/edupublisher/pages/import.php","?package="+d+"&course="+c+"&section="+e)},initImportLoadCourses:function(e,f){console.log("MAIN.initIportLoadCourses(uniqid, initial)",e,f);var g=this;a("#courseid-"+e).empty().attr("disabled","disabled"),a("#sectionid-"+e).empty().attr("disabled","disabled");var h=+a("#packageid-"+e).val();d.get_strings([{key:"loading",component:"core"}]).done(function(i){a("#courseid-"+e+", #sectionid-"+e).append(a("<option>").html(i[0])),b.call([{methodname:"block_edupublisher_init_import_load_courses",args:{packageid:h},done:function(b){console.log("Result",b);var b=JSON.parse(b);if(a("#courseid-"+e).empty(),"undefined"!=typeof b.courses&&Object.keys(b.courses).length>0){a("#courseid-"+e).removeAttr("disabled");var h=0;Object.keys(b.courses).forEach(function(c){var d=b.courses[c],g=a("<option>").attr("value",d.id).html(d.fullname);a("#courseid-"+e).append(g),0==h&&"undefined"!=typeof f&&(h=d.id),"undefined"!=typeof f&&f==d.id&&g.attr("selected","selected")}),g.initImportLoadSections(e)}else d.get_strings([{key:"error",component:"core"}]).done(function(b){a("#courseid-"+e).append(a("<option>").html(b[0])),a("#sectionid-"+e).append(a("<option>").html(b[0]))}).fail(c.exception),c.show("error","no courses")},fail:c.exception}])}).fail(c.exception)},initImportLoadSections:function(e){a("#sectionid-"+e).empty().attr("disabled","disabled"),d.get_strings([{key:"loading",component:"core"}]).done(function(f){a("#sectionid-"+e).append(a("<option>").html(f[0])),b.call([{methodname:"block_edupublisher_init_import_load_sections",args:{courseid:+a("#courseid-"+e).val()},done:function(b){console.log("Result",b);var b=JSON.parse(b);if(a("#sectionid-"+e).empty(),"undefined"!=typeof b.sections&&Object.keys(b.sections).length>0){a("#sectionid-"+e).removeAttr("disabled");var f=0;Object.keys(b.sections).forEach(function(c){var d=b.sections[c];d.name||(d.name="#"+f),a("#sectionid-"+e).append(a("<option>").attr("value",d.id).html(d.name)),f++})}else d.get_strings([{key:"error",component:"core"}]).done(function(b){a("#sectionid-"+e).append(a("<option>").html(b[0]))}).fail(c.exception)},fail:c.exception}])}).fail(c.exception)},injectEnrolButton:function(b){console.log("MAIN.injectEnrolButton(courseid)",b);var d={url:f.fileUrl("/blocks/edupublisher/pages","/self_enrol.php?id="+b)};e.render("block_edupublisher/inject_enrol_button",d).then(function(b,c){e.prependNodeContents("#page-content #region-main-box",b,c),a(".course-guestaccess-infobox").remove()}).fail(c.exception)},preparePackageForm:function(a){console.log("MAIN.preparePackageForm(channels)",a),require(["jquery"],function(b){if("undefined"!=typeof a){a=a.split(",");for(var c=0;c<a.length;c++)"default"!=a[c]&&(b('div[role="main"] #id_'+a[c]+"_publishas").is(":checked")?b('div[role="main"] input[name="id"]').val()>0&&b('div[role="main"] #id_'+a[c]+"_publishas").attr("disabled","disabled"):b('div[role="main"] #id_'+a[c]+"_publish_as").css("display","none"))}})},search:function(a,b,c){var d=this;console.log("MAIN.search(uniqid, courseid, sectionid)",a,b,c),d.watchValue({courseid:b,sectionid:c,target:"#"+a+"-search",uniqid:a,run:function(){var a=this;require(["block_edupublisher/main"],function(b){b.searchNow(a)})}},200)},searchNow:function(e,f){e.subjectareas=[],"undefined"!=typeof f&&"subjectarea"==a(f).attr("name")&&(a(f).toggleClass("selected"),a("."+e.uniqid+"-subjectarea").prop("checked",!1),a("."+e.uniqid+"-subjectarea.selected").prop("checked",!0)),a("."+e.uniqid+"-subjectarea.selected").each(function(){e.subjectareas[e.subjectareas.length]=a(this).attr("value")}),e.search=a("#"+e.uniqid+"-search").val();var g={courseid:e.courseid,search:e.search,subjectareas:e.subjectareas.join(",")};require(["block_edupublisher/main"],function(f){f.searchid++;var h=f.searchid;console.log("Doing search via ajax for",g,f.searchid,h),b.call([{methodname:"block_edupublisher_search",args:g,done:function(b){if(f.searchid!=h)console.log(" => Got response for searchid ",h," but it is not the current search",f.searchid);else{console.log("Result",b);var b=JSON.parse(b);console.log("Received",b),a("ul#"+e.uniqid+"-results").empty();var g=Object.keys(b.relevance),i=[0,1,2],j=[!1,!1,!1];if(0===g.length)d.get_strings([{key:"search:enter_term",component:"block_edupublisher"}]).done(function(b){a("ul#"+e.uniqid+"-results").append(a("<li>").append('<a href="#">').append("<h3>").html(b[0]))}).fail(c.exception);else if(1===g.length)var i=[0,0,g[0],g[0]+1];else if(2===g.length)var k=Math.round(g[g.length-1]),i=[0,0,k/2,k];else var k=Math.round(g[g.length-1]),i=[0,k/3,k/3*2,k];for(var l=0,m=g.length-1;m>=0;m--){var n=g[m],o=b.relevance[n];if(0!=o.length){for(var p=-1,q=0;q<i.length;q++)console.log("Compare ",q,"of ",i," to ",n),n>=i[q]&&(p=q),console.log("=> Stage is ",p);p>-1&&!j[p]&&(f.searchTemplate(e.uniqid,l++,"block_edupublisher/search_li_divider",{stage0:0==p,stage1:1==p,stage2:2==p,stage3:3==p}),j[p]=!0);for(var q=0;q<o.length;q++){var r=b.packages[o[q]];r.importtocourseid=e.courseid,r.importtosectionid=e.sectionid,r.showpreviewbutton=!0,console.log("Call list-template for item ",r.id),f.searchTemplate(e.uniqid,l++,"block_edupublisher/search_li",r)}}}}},fail:c.exception}])})},searchPrint:function(a){for(var b=this,c=!0,d=Object.keys(b.loadpositions[a]),f=0;f<d.length;f++){var g=d[f];b.loadpositions[a][g]||(c=!1)}if(c)for(var f=0;f<d.length;f++){var g=d[f];e.appendNodeContents("ul#"+a+"-results",b.loadpositions[a][g].html,b.loadpositions[a][g].js)}},searchTemplate:function(a,b,c,d){console.log("Call template",c," for object ",d);var f=this;"undefined"==typeof f.loadpositions[a]&&(f.loadpositions[a]=[]),f.loadpositions[a][b]=!1,e.render(c,d).then(function(e,g){console.log("Received a template",c," for object",d),f.loadpositions[a][b]={html:e,js:g},f.searchPrint(a)}).fail(function(a){console.error(a)})},storePublisher:function(d,f){var g=this,h=a("#active-"+d).prop("checked")?1:0,i=parseInt(a("#id-"+d).val()),j=a("#name-"+d).val();if(0!=j.length){var k={active:h,id:i,name:j};console.log(k,f),b.call([{methodname:"block_edupublisher_store_publisher",args:k,done:function(b){try{b=JSON.parse(b);var d=Object.keys(b);g.triggerConfirm(a(f).closest("tr"),1,"success");for(var h=0;h<d.length;h++){var i=b[d[h]],j=a("#publisher-"+i.id);if(0==j.length){var j=a("#publisher-0").attr("id","publisher-"+i.id),k=a(j).attr("data-uniqid");a(j).find("#id-"+k).val(i.id),a(j).find("#edit-"+k+">*").css("opacity",1).attr("href","/blocks/edupublisher/pages/publishers.php?id="+i.id),e.render("block_edupublisher/publisher",{id:0,name:""}).then(function(b,c){a(b).insertAfter(a(".edupublisher-publishers").last())}).fail(function(a){c.exception(a)})}else{var k=a(j).attr("data-uniqid");a(j).find("#active-"+k).prop("checked",i.active),a(j).find("#name-"+k).val(i.name)}}}catch(l){console.error("Invalid response"),g.triggerConfirm(a(f).closest("tr"),1,"error")}},fail:c.exception}])}},storePublisherUsers:function(d,e){var f=a("#publisherid-"+d).val(),g="";"add"==e&&(g=a("#userids-"+d).val()),"remove"==e&&(g=a("#users-"+d).val().join(" "));var h={action:e,publisherid:f,userids:g};console.log(h),b.call([{methodname:"block_edupublisher_store_publisher_user",args:h,done:function(b){try{b=JSON.parse(b),console.log("Response",b);for(var c=a("#users-"+d).empty(),e=Object.keys(b),f=0;f<e.length;f++){var g=b[e[f]];a(c).append(a("<option>").attr("value",g.id).html(g.fullname))}}catch(h){console.error("Invalid response",h,b)}},fail:c.exception}])},triggerActive:function(d,e,f){console.log({packageid:d,type:e,to:a(f).is(":checked")?1:0}),b.call([{methodname:"block_edupublisher_trigger_active",args:{packageid:d,type:e,to:a(f).is(":checked")?1:0},done:function(b){console.log(f,b);try{b=JSON.parse(b);for(var c=Object.keys(b),d=0;d<c.length;d++){var e=c[d].split("_"),f=e[0];1==parseInt(b[c[d]])?(a("#channel-"+f).addClass("channel-active").removeClass("channel-inactive"),a("#channel-"+f+"-active").prop("checked",!0)):(a("#channel-"+f).addClass("channel-inactive").removeClass("channel-active"),a("#channel-"+f+"-active").prop("checked",!1))}}catch(g){console.error("Invalid response")}},fail:c.exception}])},triggerRating:function(d,e,f){console.log({packageid:e,to:f}),b.call([{methodname:"block_edupublisher_rate",args:{packageid:e,to:f},done:function(b){console.log(e,b),a("#"+d+"-ratingcount").html(b.amount);for(var c=1;c<=5;c++)a("#"+d+"-rating-"+c).attr("src","/blocks/edupublisher/pix/star_"+(b.average>=c?1:0)+"_"+(b.current==c?1:0)+".png")},fail:c.exception}])},triggerConfirm:function(b,c,d){var e=this;1==c?(a(b).addClass("block-edupublisher-"+d),setTimeout(function(){e.triggerConfirm(b,0,d)},2e3)):a(b).removeClass("block-edupublisher-"+d)},watchValue:function(b,c){this.debug>5&&console.log("MAIN.watchValue(o, interval)",b,c),"undefined"==typeof c&&(c=1e3);"1"!=a(b.target).attr("data-iswatched")&&(a(b.target).attr("data-iswatched",1),b.interval=setInterval(function(){a(b.target).val()==b.compareto?(b.run(),clearInterval(b.interval),a(b.target).attr("data-iswatched",0)):b.compareto=a(b.target).val()},c))}}});