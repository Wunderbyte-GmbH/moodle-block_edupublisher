define(["jquery","core/ajax","core/notification","core/str","core/templates","core/url","core/modal_factory","core/modal_events"],function(g,c,e,f,d,b,a,h){return{searchid:0,loadpositions:{},cancelPackageForm:function(i){var j=this;f.get_strings([{key:"removal:title",component:"block_edupublisher"},{key:"removal:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(k){e.confirm(k[0],k[1],k[2],k[3],function(){top.location.href=i})}).fail(e.exception)},clickImportConfirmation:function(){g('#page-content div[role="main"] form[action*="/edupublisher/pages/import.php"]').submit()},confirmDeleteGroup:function(i){var j=this;f.get_strings([{key:"groups:remove:title",component:"block_edupublisher"},{key:"groups:remove:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(k){e.confirm(k[0],k[1],k[2],k[3],function(){top.location.href=i})}).fail(e.exception)},confirmRemoval:function(i){var j=this;f.get_strings([{key:"removal:title",component:"block_edupublisher"},{key:"removal:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(k){e.confirm(k[0],k[1],k[2],k[3],function(){top.location.href=i})}).fail(e.exception)},exportCourseWarning:function(){var i=this;var j=g("#id_exportcourse").is(":checked");if(!j){f.get_strings([{key:"exportcourse",component:"block_edupublisher"},{key:"exportcourse_help",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(k){e.confirm(k[0],k[1],k[2],k[3],function(){},function(){g("#id_exportcourse").prop("checked",true)})}).fail(e.exception)}},initImportSelection:function(k,l,i){var j=this;f.get_strings([{key:"import",component:"core"},]).done(function(m){a.create({title:m[0],body:d.render("block_edupublisher/init_import_selection",{packageid:k,courseid:l,allowsubcourses:i}),}).done(function(n){n.show()})}).fail(e.exception)},initImportLoadGo:function(m){var j=this;var l=g("#courseid-"+m).val();var k=g("#packageid-"+m).val();var i=g("#sectionid-"+m).val();var n=g("#assubcourse-"+m).prop("checked")?1:0;top.location.href=b.fileUrl("/blocks/edupublisher/pages/import.php","?package="+k+"&course="+l+"&section="+i+"&assubcourse="+n)},initImportLoadCourses:function(l,i){console.log("MAIN.initIportLoadCourses(uniqid, initial)",l,i);var j=this;g("#courseid-"+l).empty().attr("disabled","disabled");g("#sectionid-"+l).empty().attr("disabled","disabled");var k=+g("#packageid-"+l).val();f.get_strings([{key:"loading",component:"core"},]).done(function(m){g("#courseid-"+l+", #sectionid-"+l).append(g("<option>").html(m[0]));c.call([{methodname:"block_edupublisher_init_import_load_courses",args:{packageid:k},done:function(n){console.log("Result",n);var n=JSON.parse(n);g("#courseid-"+l).empty();if(typeof n.courses!=="undefined"&&Object.keys(n.courses).length>0){g("#courseid-"+l).removeAttr("disabled");var o=0;Object.keys(n.courses).forEach(function(q){var r=n.courses[q];var p=g("<option>").attr("value",r.id).html(r.fullname);g("#courseid-"+l).append(p);if(o==0&&typeof i!=="undefined"){o=r.id}if(typeof i!=="undefined"&&i==r.id){p.attr("selected","selected")}});j.initImportLoadSections(l)}else{f.get_strings([{key:"error",component:"core"},]).done(function(p){g("#courseid-"+l).append(g("<option>").html(p[0]));g("#sectionid-"+l).append(g("<option>").html(p[0]))}).fail(e.exception);e.show("error","no courses")}},fail:e.exception}])}).fail(e.exception)},initImportLoadSections:function(j){var i=this;g("#sectionid-"+j).empty().attr("disabled","disabled");f.get_strings([{key:"loading",component:"core"},]).done(function(k){g("#sectionid-"+j).append(g("<option>").html(k[0]));c.call([{methodname:"block_edupublisher_init_import_load_sections",args:{courseid:+g("#courseid-"+j).val()},done:function(l){console.log("Result",l);var l=JSON.parse(l);g("#sectionid-"+j).empty();if(typeof l.sections!=="undefined"&&Object.keys(l.sections).length>0){g("#sectionid-"+j).removeAttr("disabled");var m=0;Object.keys(l.sections).forEach(function(n){var o=l.sections[n];if(!o.name){o.name="#"+(m)}g("#sectionid-"+j).append(g("<option>").attr("value",o.id).html(o.name));m++})}else{f.get_strings([{key:"error",component:"core"},]).done(function(n){g("#sectionid-"+j).append(g("<option>").html(n[0]))}).fail(e.exception)}},fail:e.exception}])}).fail(e.exception)},injectEnrolButton:function(k,i){console.log("MAIN.injectEnrolButton(courseid, isguestuser)",k,i);var j={isguestuser:i,url:b.relativeUrl("/blocks/edupublisher/pages/self_enrol.php",{id:k}),};d.render("block_edupublisher/inject_enrol_button",j).then(function(l,m){d.prependNodeContents("#page-content #region-main-box",l,m);g(".course-guestaccess-infobox").remove()}).fail(e.exception)},preparePackageForm:function(i){var j=this;console.log("MAIN.preparePackageForm(channels)",i);require(["jquery"],function(l){if(typeof i!=="undefined"){i=i.split(",");for(var k=0;k<i.length;k++){if(i[k]=="default"){continue}if(!l('div[role="main"] #id_'+i[k]+"_publishas").is(":checked")){l('div[role="main"] #id_'+i[k]+"_publish_as").css("display","none")}else{if(l('div[role="main"] input[name="id"]').val()>0){l('div[role="main"] #id_'+i[k]+"_publishas").attr("disabled","disabled")}}}}})},search:function(l,k,i){var j=this;console.log("MAIN.search(uniqid, courseid, sectionid)",l,k,i);j.watchValue({courseid:k,sectionid:i,target:"#"+l+"-search",uniqid:l,run:function(){var m=this;require(["block_edupublisher/main"],function(n){n.searchNow(m)})}},200)},searchNow:function(k,i){k.subjectareas=[];k.schoollevels=[];if(typeof i!=="undefined"){if(g(i).attr("name")=="subjectarea"){g(i).toggleClass("selected");g("."+k.uniqid+"-subjectarea").prop("checked",false);g("."+k.uniqid+"-subjectarea.selected").prop("checked",true)}if(g(i).attr("name")=="schoollevel"){g(i).toggleClass("selected");g("."+k.uniqid+"-schoollevel").prop("checked",false);g("."+k.uniqid+"-schoollevel.selected").prop("checked",true)}}g("."+k.uniqid+"-subjectarea.selected").each(function(){k.subjectareas[k.subjectareas.length]=g(this).attr("value")});g("."+k.uniqid+"-schoollevel.selected").each(function(){k.schoollevels[k.schoollevels.length]=g(this).attr("value")});k.search=g("#"+k.uniqid+"-search").val();var j={courseid:k.courseid,search:k.search,subjectareas:k.subjectareas.join("zzzZZZzzz"),schoollevels:k.schoollevels.join("zzzZZZzzz")};require(["block_edupublisher/main"],function(l){l.searchid++;var m=l.searchid;c.call([{methodname:"block_edupublisher_search",args:j,done:function(o){if(l.searchid!=m){}else{var o=JSON.parse(o);g("ul#"+k.uniqid+"-results").empty();if(o.packages.length===0){f.get_strings([{key:"search:enter_term",component:"block_edupublisher"},]).done(function(r){g("ul#"+k.uniqid+"-results").append(g("<li>").append('<a href="#">').append("<h3>").html(r[0]))}).fail(e.exception)}var n=0;for(var p=o.packages.length-1;p>=0;p--){var q=o.packages[p];q.importtocourseid=k.courseid;q.importtosectionid=k.sectionid;q.showpreviewbutton=true;l.searchTemplate(k.uniqid,n++,"block_edupublisher/search_li",q)}}},fail:e.exception}])})},searchPrint:function(n){var m=this;var l=true;var k=Object.keys(m.loadpositions[n]);for(var j=0;j<k.length;j++){var i=k[j];if(!m.loadpositions[n][i]){l=false}}if(l){for(var j=0;j<k.length;j++){var i=k[j];d.appendNodeContents("ul#"+n+"-results",m.loadpositions[n][i].html,m.loadpositions[n][i].js)}}},searchTemplate:function(l,i,k,m){console.log("Call template",k," for object ",m);var j=this;if(typeof j.loadpositions[l]==="undefined"){j.loadpositions[l]=[]}j.loadpositions[l][i]=false;d.render(k,m).then(function(n,o){j.loadpositions[l][i]={html:n,js:o};j.searchPrint(l)}).fail(function(n){console.error(n)})},storePublisher:function(p,n){var k=this;var q=this;var l=g("#active-"+p).prop("checked")?1:0;var j=parseInt(g("#id-"+p).val());var i=g("#name-"+p).val();var o=g("#mail-"+p).val();if(i.length==0){return}var m={active:l,id:j,name:i,mail:o};c.call([{methodname:"block_edupublisher_store_publisher",args:m,done:function(r){try{r=JSON.parse(r);var x=Object.keys(r);q.triggerConfirm(g(n).closest("tr"),1,"success");for(var s=0;s<x.length;s++){var u=r[x[s]];var t=g("#publisher-"+u.id);if(t.length==0){var t=g("#publisher-0").attr("id","publisher-"+u.id);var w=g(t).attr("data-uniqid");g(t).find("#id-"+w).val(u.id);g(t).find("#edit-"+w+">*").css("opacity",1).attr("href","/blocks/edupublisher/pages/publishers.php?id="+u.id);d.render("block_edupublisher/publisher",{id:0,name:""}).then(function(y,z){g(y).insertAfter(g(".edupublisher-publishers").last())}).fail(function(y){e.exception(y)})}else{var w=g(t).attr("data-uniqid");g(t).find("#active-"+w).prop("checked",u.active);g(t).find("#name-"+w).val(u.name);g(t).find("#mail-"+w).val(u.mail)}}}catch(v){console.error("Invalid response");q.triggerConfirm(g(n).closest("tr"),1,"error")}},fail:e.exception}])},storePublisherUsers:function(o,n){var l=this;var k=this;var i=g("#publisherid-"+o).val();var j="";if(n=="add"){j=g("#userids-"+o).val()}if(n=="remove"){j=g("#users-"+o).val().join(" ")}var m={action:n,publisherid:i,userids:j};console.log(m);c.call([{methodname:"block_edupublisher_store_publisher_user",args:m,done:function(p){try{p=JSON.parse(p);console.log("Response",p);var s=g("#users-"+o).empty();var u=Object.keys(p);for(var q=0;q<u.length;q++){var r=p[u[q]];g(s).append(g("<option>").attr("value",r.id).html(r.fullname))}}catch(t){console.error("Invalid response",t,p)}},fail:e.exception}])},triggerActive:function(m,l,j){var k=this;var i=this;console.log({packageid:m,type:l,to:g(j).is(":checked")?1:0});c.call([{methodname:"block_edupublisher_trigger_active",args:{packageid:m,type:l,to:g(j).is(":checked")?1:0},done:function(o){console.log(q,o);try{o=JSON.parse(o);var s=Object.keys(o);for(var p=0;p<s.length;p++){var n=s[p].split("_");var q=n[0];if(parseInt(o[s[p]])==1){g("#channel-"+q).addClass("channel-active").removeClass("channel-inactive");g("#channel-"+q+"-active").prop("checked",true)}else{g("#channel-"+q).addClass("channel-inactive").removeClass("channel-active");g("#channel-"+q+"-active").prop("checked",false)}}}catch(r){console.error("Invalid response")}},fail:e.exception}])},triggerRating:function(l,k,m){var j=this;var i=this;console.log({packageid:k,to:m});c.call([{methodname:"block_edupublisher_rate",args:{packageid:k,to:m},done:function(n){console.log(k,n);g("#"+l+"-ratingcount").html(n.amount);for(var o=1;o<=5;o++){g("#"+l+"-rating-"+o).attr("src","/blocks/edupublisher/pix/star_"+((n.average>=o)?1:0)+"_"+((n.current==o)?1:0)+".png")}},fail:e.exception}])},triggerConfirm:function(j,m,l){var k=this;var i=this;if(m==1){g(j).addClass("block-edupublisher-"+l);setTimeout(function(){i.triggerConfirm(j,0,l)},2000)}else{g(j).removeClass("block-edupublisher-"+l)}},watchValue:function(l,j){var k=this;if(this.debug>5){console.log("MAIN.watchValue(o, interval)",l,j)}if(typeof j==="undefined"){j=1000}var i=this;if(g(l.target).attr("data-iswatched")!="1"){g(l.target).attr("data-iswatched",1);l.interval=setInterval(function(){if(g(l.target).val()==l.compareto){l.run();clearInterval(l.interval);g(l.target).attr("data-iswatched",0)}else{l.compareto=g(l.target).val()}},j)}},}});